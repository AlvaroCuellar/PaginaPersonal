<!-- Publications Section -->
<section id="publications" class="cv-section">
  <h2 class="section-title">
    {{ site.data.cv.publications.section_title[page.lang] }}
  </h2>

  {% assign lang = page.lang %}
  {% assign organization = site.data.cv.publications.organization | default: "by_type" %}

  {% if organization == "by_year" %}
    <!-- Organization by year -->
    {% assign all_publications = site.data.bibliography | values %}
    {% assign publications_with_year = all_publications | where_exp: "item", "item.year != nil and item.year != ''" %}
    {% assign publications = publications_with_year | sort: 'year' | reverse %}
    {% assign current_year = "" %}
    {% for entry in publications %}
      {% if entry.year != current_year %}
        {% assign current_year = entry.year %}
        <h3 class="subsection-title">{{ current_year }}</h3>
      {% endif %}
      
      <!-- Publication Item -->
      <div class="item-container">
        {% if entry.author %}
          <div class="publication-author">{{ entry.author }}</div>
        {% endif %}
        <div class="publication-title">{{ entry.title }}</div>
        <div class="publication-details">
          {% assign source_text = "" %}
          {% if entry.journal and entry.journal != "" %}
            {% assign source_text = "<em>" | append: entry.journal | append: "</em>" %}
          {% endif %}
          {% if entry.booktitle and entry.booktitle != "" %}
            {% assign source_text = site.data.i18n[lang].publication_text.in | append: " <em>" | append: entry.booktitle | append: "</em>" %}
          {% endif %}
          {% if entry.year and entry.year != "" %}
            {% if source_text != "" %}{% assign source_text = source_text | append: ", " %}{% endif %}
            {% assign source_text = source_text | append: entry.year %}
          {% endif %}
          {{ source_text }}
          
          {% assign detail_parts = "" | split: "" %}
          {% if entry.publisher and entry.publisher != "" %}{% assign detail_parts = detail_parts | push: entry.publisher %}{% endif %}
          {% if entry.address and entry.address != "" %}{% assign detail_parts = detail_parts | push: entry.address %}{% endif %}
          {% if entry.pages and entry.pages != "" %}{% assign detail_parts = detail_parts | push: entry.pages %}{% endif %}
          {% if detail_parts.size > 0 %}, {{ detail_parts | join: ", " }}{% endif %}
          
          {% comment %} Enlaces en nueva línea para URL y DOI {% endcomment %}
          {% if entry.url and entry.url != "" %}<br><a href="{{ entry.url }}" target="_blank">{{ entry.url }}</a>{% endif %}
          {% if entry.doi and entry.doi != "" %}<br><a href="https://doi.org/{{ entry.doi }}" target="_blank">DOI: {{ entry.doi }}</a>{% endif %}
          
          {% comment %} Botones solo para recursos adicionales {% endcomment %}
          {% assign key = entry.key %}
          {% assign links = site.data.cv.publications.links[key] %}
          {% if links.pdf or links.code or links.slides or links.data or links.video or links.poster %}
            <div class="publication-resources">
              {% if links.pdf %}<a href="{{ links.pdf }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.pdf }}</a>{% endif %}
              {% if links.code %}<a href="{{ links.code }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.code }}</a>{% endif %}
              {% if links.slides %}<a href="{{ links.slides }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.slides }}</a>{% endif %}
              {% if links.data %}<a href="{{ links.data }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.data }}</a>{% endif %}
              {% if links.video %}<a href="{{ links.video }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.video }}</a>{% endif %}
              {% if links.poster %}<a href="{{ links.poster }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.poster }}</a>{% endif %}
            </div>
          {% endif %}
        </div>
      </div>
      
    {% endfor %}
  {% else %}
    <!-- Organization by type -->
    {% assign publications = site.data.bibliography | values %}
    {% assign types_order = "article,inproceedings,incollection,book,phdthesis,mastersthesis,misc" | split: "," %}
    
    {% for type in types_order %}
      {% assign type_publications = publications | where: "type", type %}
      {% if type_publications.size > 0 %}
        <h3 class="subsection-title">
          {{ site.data.i18n[lang].publication_types[type] | default: type | capitalize }}
        </h3>
        {% assign sorted_pubs = type_publications | sort: 'year' | reverse %}
        {% for entry in sorted_pubs %}
          
          <!-- Publication Item -->
          <div class="item-container">
            {% if entry.author %}
              <div class="publication-author">{{ entry.author }}</div>
            {% endif %}
            <div class="publication-title">{{ entry.title }}</div>
            <div class="publication-details">
              {% assign source_text = "" %}
              {% if entry.journal and entry.journal != "" %}
                {% assign source_text = "<em>" | append: entry.journal | append: "</em>" %}
              {% endif %}
              {% if entry.booktitle and entry.booktitle != "" %}
                {% assign source_text = site.data.i18n[lang].publication_text.in | append: " <em>" | append: entry.booktitle | append: "</em>" %}
              {% endif %}
              {% if entry.year and entry.year != "" %}
                {% if source_text != "" %}{% assign source_text = source_text | append: ", " %}{% endif %}
                {% assign source_text = source_text | append: entry.year %}
              {% endif %}
              {{ source_text }}
              
              {% assign detail_parts = "" | split: "" %}
              {% if entry.publisher and entry.publisher != "" %}{% assign detail_parts = detail_parts | push: entry.publisher %}{% endif %}
              {% if entry.address and entry.address != "" %}{% assign detail_parts = detail_parts | push: entry.address %}{% endif %}
              {% if entry.pages and entry.pages != "" %}{% assign detail_parts = detail_parts | push: entry.pages %}{% endif %}
              {% if detail_parts.size > 0 %}, {{ detail_parts | join: ", " }}{% endif %}
              
              {% comment %} Enlaces en nueva línea para URL y DOI {% endcomment %}
              {% if entry.url and entry.url != "" %}<br><a href="{{ entry.url }}" target="_blank">{{ entry.url }}</a>{% endif %}
              {% if entry.doi and entry.doi != "" %}<br><a href="https://doi.org/{{ entry.doi }}" target="_blank">DOI: {{ entry.doi }}</a>{% endif %}
              
              {% comment %} Botones solo para recursos adicionales {% endcomment %}
              {% assign key = entry.key %}
              {% assign links = site.data.cv.publications.links[key] %}
              {% if links.pdf or links.code or links.slides or links.data or links.video or links.poster %}
                <div class="publication-resources">
                  {% if links.pdf %}<a href="{{ links.pdf }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.pdf }}</a>{% endif %}
                  {% if links.code %}<a href="{{ links.code }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.code }}</a>{% endif %}
                  {% if links.slides %}<a href="{{ links.slides }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.slides }}</a>{% endif %}
                  {% if links.data %}<a href="{{ links.data }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.data }}</a>{% endif %}
                  {% if links.video %}<a href="{{ links.video }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.video }}</a>{% endif %}
                  {% if links.poster %}<a href="{{ links.poster }}" target="_blank" class="button no-icon">{{ site.data.i18n[lang].publication_buttons.poster }}</a>{% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          
        {% endfor %}
      {% endif %}
    {% endfor %}
  {% endif %}
</section>
