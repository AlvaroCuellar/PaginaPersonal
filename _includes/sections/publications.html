<section id="publications" class="publications scrollto">
  <div class="row clearfix">
    {% assign lang = page.lang | default: 'es' %}
    <div class="col-1">
      <div class="section-heading">
        {% if site.data.home.publications.subtitle[lang] %}
          <h3>{{ site.data.home.publications.subtitle[lang] }}</h3>
        {% endif %}
        <h2 class="section-title">
          {{ site.data.home.publications.section_title[lang] }}
          <span class="section-count">{{ site.data.home.publications.publications.size }}</span>
        </h2>
        {% assign total_citations = 0 %}
        {% for pub in site.data.home.publications.publications %}
          {% if pub.cited_by and pub.cited_by.size > 0 %}
            {% assign total_citations = total_citations | plus: pub.cited_by.size %}
          {% endif %}
        {% endfor %}
        {% if total_citations > 0 %}
        <div class="total-citations">
          <i class="fa fa-quote-left"></i>
          <span class="total-citations-number ">{{ total_citations }}</span>
          <span class="total-citations-label">{{ site.data.i18n[lang].total_citations | default: "citas totales" }}</span>
        </div>
        {% endif %}
      </div>

      <!-- Featured Publications Carousel -->
      <div class="featured-carousel-container">
        <h3 class="subsection-title">{{ site.data.i18n[lang].featured_publications_title | default: "Publicaciones destacadas" }}</h3>
        <div class="featured-carousel">
          {% for pub_id in site.data.home.publications.featured_ids %}
            {% assign pub = site.data.home.publications.publications | where: "id", pub_id | first %}
            {% if pub %}
              <div class="carousel-slide">
                <div class="featured-publication-card">
                  <!-- Featured Badge -->
                  <div class="featured-badge featured-badge-absolute featured-badge-top-left">
                    <i class="fa fa-star"></i>
                    <span>{{ site.data.i18n[lang].featured_label }}</span>
                  </div>
              {% if pub.thumbnail %}
                <div class="publication-thumbnail">
                  <img src="{{ pub.thumbnail }}" alt="{{ pub.title }}" class="pub-thumb">
                </div>
              {% endif %}
              <div class="publication-content">
                <h5 class="category-label">{{ site.data.i18n[lang].publication_types[pub.type] | default: pub.type | capitalize }}</h5>
                <div class="publication-title">{{ pub.title }}</div>
                <div class="publication-authors">{{ pub.authors | join: ", " }}</div>
                <div class="publication-metadata">
                  <div class="publication-source">
                    {% assign source_text = "" %}
                    {% if pub.publication and pub.publication != "" %}
                      {% assign source_text = "<em>" | append: pub.publication | append: "</em>" %}
                    {% endif %}
                    {% if pub.volume %}
                      {% assign source_text = source_text | append: " Vol. " | append: pub.volume %}
                    {% endif %}
                    {% if pub.number %}
                      {% assign source_text = source_text | append: " Nº " | append: pub.number %}
                    {% endif %}
                    {% if pub.pages %}
                      {% assign source_text = source_text | append: ", pp. " | append: pub.pages %}
                    {% endif %}
                    {% if pub.year and pub.year != "" %}
                      {% if source_text != "" %}{% assign source_text = source_text | append: ", " %}{% endif %}
                      {% assign source_text = source_text | append: pub.year %}
                    {% endif %}
                    {% if pub.place %}
                      {% assign source_text = source_text | append: ", " | append: pub.place %}
                    {% endif %}
                    {% if pub.publisher %}
                      {% assign source_text = source_text | append: ", " | append: pub.publisher %}
                    {% endif %}
                    {% if pub.isbn %}
                      {% assign source_text = source_text | append: ", ISBN: " | append: pub.isbn %}
                    {% endif %}
                    {{ source_text }}
                  </div>
                </div>
                <div class="publication-buttons">
                  {% if pub.url %}
                    <a href="{{ pub.url }}" target="_blank" class="button-inverse no-icon">{{ site.data.i18n[lang].access_text | default: "Acceder" }}</a>
                  {% endif %}
                  {% if pub.cited_by and pub.cited_by.size > 0 %}
                    <button class="button no-icon" onclick="toggleCitationOverlay('{{ pub.id }}-featured')">
                      {{ site.data.i18n[lang].view_citations | default: "Ver citas" }} <span class="citation-badge-number">{{ pub.cited_by.size }}</span>
                    </button>
                  {% endif %}
                </div>
                <!-- Citation Overlay para el botón -->
                {% if pub.cited_by and pub.cited_by.size > 0 %}
                <div id="{{ pub.id }}-featured-overlay" class="citation-overlay hidden">
                  <div class="citation-overlay-content">
                    <div class="citation-overlay-header">
                      <h4>{{ site.data.i18n[lang].cited_by_title | default: "Citado por" }} ({{ pub.cited_by.size }})</h4>
                      <button class="citation-close" onclick="toggleCitationOverlay('{{ pub.id }}-featured')">&times;</button>
                    </div>
                    <div class="citation-list" style="counter-reset: citation-counter {{ pub.cited_by.size | plus: 1 }};">
                      {% for citation in pub.cited_by %}
                        <div class="citation-item">{{ citation }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
        
        <!-- Scroll Indicator -->
        <div class="carousel-scroll-indicator">
          <button class="scroll-hint-button" aria-label="{{ site.data.i18n[lang].carousel_scroll_hint | default: 'Desliza para ver más' }}">
            <span class="scroll-hint-text">{{ site.data.i18n[lang].carousel_scroll_hint | default: "Desliza para ver más" }}</span>
            <i class="fa fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- All Publications -->
      <h3 class="subsection-title">{{ site.data.i18n[lang].all_publications_title | default: "Todas las publicaciones" }}</h3>

      <!-- All Publications Grid -->
      <div class="publication-grid">
        {% assign initial_visible = 5 %}
        {% assign pub_count = 0 %}
        {% assign featured_ids = site.data.home.publications.featured_ids %}
        {% assign repeat_featured = site.data.home.publications.repeat_featured_in_all %}
        {% for pub in site.data.home.publications.publications %}
          {% if repeat_featured %}
            {% assign show_pub = true %}
          {% else %}
            {% assign show_pub = true %}
            {% if featured_ids contains pub.id %}
              {% assign show_pub = false %}
            {% endif %}
          {% endif %}
          {% if show_pub %}
            {% assign pub_count = pub_count | plus: 1 %}
            <div class="publication-item{% if pub_count > initial_visible %} hidden{% endif %}">
          <div class="publication-card">
            <!-- Thumbnail -->
            {% if pub.thumbnail %}
              <div class="publication-thumbnail-grid">
                <img src="{{ pub.thumbnail }}" alt="{{ pub.title }}" class="pub-thumb-grid">
              </div>
            {% endif %}
            
            <!-- Content - Metadatos (columna 2) -->
            <div class="publication-content-grid">
              <h5 class="category-label">{{ site.data.i18n[lang].publication_types[pub.type] | default: pub.type | capitalize }}</h5>
              <div class="publication-title">{{ pub.title }}</div>
              <div class="publication-authors">{{ pub.authors | join: ", " }}</div>
              <div class="publication-metadata">
                <div class="publication-source">
                  {% assign source_text = "" %}
                  {% if pub.publication and pub.publication != "" %}
                    {% assign source_text = "<em>" | append: pub.publication | append: "</em>" %}
                  {% endif %}
                  {% if pub.volume %}
                    {% assign source_text = source_text | append: " Vol. " | append: pub.volume %}
                  {% endif %}
                  {% if pub.number %}
                    {% assign source_text = source_text | append: " Nº " | append: pub.number %}
                  {% endif %}
                  {% if pub.pages %}
                    {% assign source_text = source_text | append: ", pp. " | append: pub.pages %}
                  {% endif %}
                  {% if pub.year and pub.year != "" %}
                    {% if source_text != "" %}{% assign source_text = source_text | append: ", " %}{% endif %}
                    {% assign source_text = source_text | append: pub.year %}
                  {% endif %}
                  {% if pub.place %}
                    {% assign source_text = source_text | append: ", " | append: pub.place %}
                  {% endif %}
                  {% if pub.publisher %}
                    {% assign source_text = source_text | append: ", " | append: pub.publisher %}
                  {% endif %}
                  {% if pub.isbn %}
                    {% assign source_text = source_text | append: ", ISBN: " | append: pub.isbn %}
                  {% endif %}
                  {{ source_text }}
                </div>
                
                <!-- Buttons: Acceder + Ver citas -->
                <div class="publication-buttons-inline">
                  {% if pub.url %}
                    <a href="{{ pub.url }}" target="_blank" class="button-inverse no-icon">{{ site.data.i18n[lang].access_text | default: "Acceder" }}</a>
                  {% endif %}
                  {% if pub.cited_by and pub.cited_by.size > 0 %}
                    <button class="button no-icon" onclick="toggleCitationOverlay('{{ pub.id }}-normal')">
                      {{ site.data.i18n[lang].view_citations | default: "Ver citas" }} <span class="citation-badge-number">{{ pub.cited_by.size }}</span>
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Abstract (columna 3) -->
            {% if pub.abstract %}
            <div class="publication-abstract">
              <div class="abstract-text">{{ pub.abstract }}</div>
            </div>
            {% endif %}
          </div>
          <!-- Citation Overlay -->
          {% if pub.cited_by and pub.cited_by.size > 0 %}
          <div id="{{ pub.id }}-normal-overlay" class="citation-overlay hidden">
            <div class="citation-overlay-content">
              <div class="citation-overlay-header">
                <h4>{{ site.data.i18n[lang].cited_by_title | default: "Citado por" }} ({{ pub.cited_by.size }})</h4>
                <button class="citation-close" onclick="toggleCitationOverlay('{{ pub.id }}-normal')">&times;</button>
              </div>
              <div class="citation-list" style="counter-reset: citation-counter {{ pub.cited_by.size | plus: 1 }};">
                {% for citation in pub.cited_by %}
                  <div class="citation-item">{{ citation }}</div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
          </div>
          {% endif %}
        {% endfor %}
      </div>

      {% if repeat_featured %}
        {% assign total_non_featured = site.data.home.publications.publications.size %}
      {% else %}
        {% assign total_non_featured = site.data.home.publications.publications.size | minus: featured_ids.size %}
      {% endif %}
      {% if total_non_featured > initial_visible %}
        <div class="show-more-publications-container">
          <button id="show-more-publications" class="button">
            {{ site.data.i18n[lang].show_more_publications | default: "Ver más publicaciones" }}
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</section>
